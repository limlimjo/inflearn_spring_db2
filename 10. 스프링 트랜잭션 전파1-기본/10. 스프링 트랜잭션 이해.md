## 스프링 트랜잭션 전파1-기본

### 스프링 트랜잭션 전파1 - 커밋, 롤백

- 트랜잭션을 획득하고 커밋, 롤백하는 부분

- 관련 코드는 github 참고 (스프링 트랜잭션 전파1 - 기본(커밋, 롤백))

---

### 스프링 트랜잭션 전파2 - 트랜잭션 두 번 사용

- 트랜잭션이 각각 따로 사용되는 경우

- 관련 코드는 github 참고 (스프링 트랜잭션 전파1 - 기본(트랜잭션 두 번 사용))

---

### 스프링 트랜잭션 전파3 - 전파 기본

- 위 방법처럼 트랜잭션을 각각 사용하는 것이 아닌 트랜잭션이 이미 진행중인데, 여기에 추가로 트랜잭션을 수행하는 경우

- 스프링은 이해를 돕기 위해 `논리 트랜잭션`과 `물리 트랜잭션`이라는 개념으로 나누는데 `논리 트랜잭션`들은 하나의 `물리 트랜잭션`으로 묶임

- `물리 트랜잭션`은 우리가 이해하는 실제 DB에 적용되는 트랜잭션을 뜻함. 실제 커넥션을 통해서 트랜잭션을 시작(`setAutoCommit(false))`) 하고, 실제 커넥션을 통해서 커밋, 롤백하는 단위임

- `논리 트랜잭션`은 트랜잭션 매니저를 통해 트랜잭션을 사용하는 단위임

- 즉, 요약하자면 아래 원칙을 따름

1. 모든 논리 트랜잭션이 커밋되어야 물리 트랜잭션이 커밋됨
2. 하나의 논리 트랜잭션이라도 롤백되면 물리 트랜잭션은 롤백됨

---

### 스프링 트랜잭션 전파4 - 전파 예제

- 관련 코드는 github 참고 (스프링 트랜잭션 전파1 - 기본(전파 예제))

---

### 스프링 트랜잭션 전파5 - 외부 롤백

- 논리 트랜잭션이 하나라도 롤백되면 전체 물리 트랜잭션은 롤백됨

- 관련 코드는 github 참고 (스프링 트랜잭션 전파1 - 기본(외부 롤백))

---

### 스프링 트랜잭션 전파6 - 내부 롤백

- 내부 논리 트랜잭션이 롤백되면 롤백 전용 마크를 표시함 (ex. `rollbackOnly=true`)

- 외부 트랜잭션을 커밋할 때 롤백 전용 마크를 확인함

- 롤백 전용 마크가 표시되어 있으면 물리 트랜잭션을 롤백하고, `UnexpectedRollbackException` 예외를 던짐

- 관련 코드는 github 참고 (스프링 트랜잭션 전파1 - 기본(내부 롤백))

---

### 스프링 트랜잭션 전파7 - REQUIRES_NEW

- `REQUIRES_NEW` 옵션을 사용하면 물리 트랜잭션이 명확하게 분리됨

- `REQUIRES_NEW`를 사용하면 데이터베이스 커넥션이 동시에 2개 사용된다는 점 주의

- 관련 코드는 github 참고 (스프링 트랜잭션 전파1 - REQUIRES_NEW)

---

### 스프링 트랜잭션 전파8 - 다양한 전파 옵션

- 스프링은 다양한 트랜잭션 전파 옵션을 제공함

- 전파 옵션에 별도의 설정을 하지 않으면 `REQUIRED`가 기존으로 사용됨

- 실무에서는 대부분 `REQUIRED` 옵션을 사용함

- `REQUIRED`

  : 가장 많이 사용하는 기본 설정

  : 기존 트랜잭션이 없으면 생성하고, 있으면 참여함

  : 기존 트랜잭션 없음 -> 새로운 트랜잭션을 생성함

  : 기존 트랜잭션 있음 -> 기존 트랜잭션에 참여함

- `REQUIRES_NEW`

  : 항상 새로운 트랜잭션을 생성함

  : 기존 트랜잭션 없음 -> 새로운 트랜잭션을 생성함

  : 기존 트랜잭션 있음 -> 새로운 트랜잭션을 생성함

- `SUPPORT`

  : 기존 트랜잭션이 없으면, 없는대로 진행하고, 있으면 참여함

  : 기존 트랜잭션 없음 -> 트랜잭션 없이 진행함

  : 기존 트랜잭션 있음 -> 기존 트랜잭션에 참여함

- `NOT_SUPPORT`

  : 트랜잭션을 지원하지 않는다는 의미임

  : 기존 트랜잭션 없음 -> 트랜잭션 없이 진행함

  : 기존 트랜잭션 있음 -> 트랜잭션 없이 진행함 (기존 트랜잭션은 보류함)

- `MANDATORY`

  : 트랜잭션이 반드시 있어야 함. 기존 트랜잭션이 없으면 예외가 발생함.

  : 기존 트랜잭션 없음 -> `IllegalTransactionStateException` 예외 발생

  : 기존 트랜잭션 있음 -> 기존 트랜잭션에 참여함

- `NEVER`

  : 트랜잭션을 사용하지 않는다는 의미임

  : 기존 트랜잭션 없음 -> 트랜잭션 없이 진행함

  : 기존 트랜잭션 있음 -> `IllegalTransactionStateException` 예외 발생

- `NESTED`

  : 기존 트랜잭션 없음 -> 새로운 트랜잭션을 생성함

  : 기존 트랜잭션 있음 -> 중첩 트랜잭션을 만듦

---

### 정리 및 회고

- 실무에서는 트랜잭션 전파 옵션에 대해 디테일하게 설정하지 않았던 것 같은데 이렇게 다양한 옵션이 있는지 처음 알았다.

- 물리 트랜잭션 트랜잭션과 논리 트랜잭션에 대한 개념도 명확히 알게 되는 계기가 되었다.
