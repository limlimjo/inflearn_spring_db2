## 스프링 트랜잭션 이해

### 스프링 트랜잭션 소개

- JDBC 기술과 JPA 기술은 트랜잭션을 사용하는 코드 자체가 다름

- 그래서 데이터 접근 기술을 변경하면 트랜잭션을 사용하는 코드 모두를 바꿔야 하는 어려움이 생김

- 스프링은 이런 문제를 두고 볼 수 없었음

- So, `PlatformTransactionManager`라는 인터페이스를 통해 트랜잭션 추상화

- 스프링 트랜잭션 사용 방식

1. `선언적 트랜잭션 관리` : `@Transactional` (실무에서 주로 사용하는 방식)

2. `프로그래밍 방식의 트랜잭션 관리`

- `선언적 트랜잭션`을 사용하게 되면 기본적으로 프록시 방식의 AOP가 적용됨

---

### 프로젝트 생성

- 스프링 트랜잭션 실습 파일 생성 => `springtx`

---

### 트랜잭션 적용 확인

- `TransactionSynchronizationManager.isActualTransactionActive()`

    : 현재 쓰레드에 트랜잭션이 적용되어 있는지 확인할 수 있는 기능

- 관련 코드는 github 참고 (트랜잭션 적용 확인)

---

### 트랜잭션 적용 위치

- 스프링에서 우선순위는 항상 더 구체적이고 자세한 것이 높은 우선순위를 가지는 것 기억!!

- 스프링 `@Transactional` 2가지 규칙

1. 우선순위 규칙

2. 클래스에 적용하면 메서드는 자동 적용

- 인터페이스에도 `@Transactional`을 적용할 수 있으나 스프링 공식 매뉴얼에서는 권장하지 않음

- 관련 코드는 github 참고 (트랜잭션 적용 위치)

---

### 트랜잭션 AOP 주의 사항 - 프록시 내부 호출1

- 트랜잭션을 적용하려면 항상 프록시를 통해서 대상 객체를 호출해야함

- 프록시를 거치지 않고 대상 객체를 직접 호출하게 되면 AOP가 적용되지 않고, 트랜잭션도 적용되지 않음

- 관련 코드는 github 참고 (트랜잭션 AOP 주의 사항 - 프록시 내부 호출1)

- 이러한 내부 호출을 피하기 위해 메서드를 별도의 클래스로 분리함

---

### 트랜잭션 AOP 주의 사항 - 프록시 내부 호출2

- 메서드 내부 호출 때문에 트랜잭션 프록시가 적용되지 않는 문제를 해결하기 위해 해당 메서드를 별도의 클래스로 분리

- 이외도 다양한 방법이 있으나 찾아봐야함

- 관련 코드는 github 참고 (트랜잭션 AOP 주의 사항 - 프록시 내부 호출2)

- 추가적으로 스프링의 트랜잭션 AOP 기능은 `public` 메서드에만 트랜잭션을 적용하도록 기본 설정이 되어있음

- 스프링부트 3.0부터는 `protected` , `package-visible` (default 접근제한자)에도 트랜잭션이 적용됨

---

### 트랜잭션 AOP 주의 사항 - 초기화 시점

- 스프링 초기화 시점에는 트랜잭션 AOP가 적용되지 않을 수 있음

- 초기화 코드가 먼저 호출되고, 그 다음에 트랜잭션 AOP가 적용되기 때문

- 관련 코드는 github 참고 (트랜잭션 AOP 주의 사항 - 초기화 시점)

---

### 트랜잭션 옵션 소개

- 스프링 트랜잭션은 다양한 옵션을 제공함

1. `value, transactionManager`

    : `@Transactional`에서도 트랜잭션 프록시가 사용할 트랜잭션 매니저를 지정해줘야하는데 이럴 때 사용하는 옵션

2. `rollbackFor`

    : 어떤 예외가 발생할 때 롤백할지 지정하는 옵션

3. `noRollbackFor`

    : 어떤 예외가 발생할 때 롤백하면 안되는지 지정하는 옵션

4. `propagation`

    : 트랜잭션 전파에 대한 옵션

5. `isolation`

    : 트랜잭션 격리 수준을 지정할 수 있는 옵션

    : 대부분 DB에서 설정한 기준을 따르며 애플리케이션 개발자가 트랜잭션 격리 수준을 직접 지정하는 경우는 드뭄

6. `timeout`

    : 트랜잭션 수행 시간에 대한 타임아웃을 초 단위로 지정할 수 있는 옵션

7. `label`

    : 트랜잭션 어노테이션에 있는 값을 직접 읽어서 어떤 동작을 하고 싶을 때 사용하는 옵션

    : 일반적으로 사용하지 않음

8. `readOnly`

    : 트랜잭션은 기본적으로 읽기 쓰기가 모두 가능한 트랜잭션이 생성되는데 `readOnly=true` 옵션을 사용하면 읽기 전용 트랜잭션이 생성됨

    - `readOnly` 옵션은 크게 3곳에서 적용됨 (프레임워크, JDBC 드라이버, 데이터베이스)

---

### 예외와 트랜잭션 커밋, 롤백 - 기본

---

### 예외와 트랜잭션 커밋, 롤백 - 활용

---

### 정리 및 회고

---